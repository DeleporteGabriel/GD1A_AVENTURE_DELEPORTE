<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" /><title>Mon 2eme jeu Phaser</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js">
    </script>

    <style type="text/css"> body 
    
        { margin: 0; }
    
    </style>
</head>
<body>
<script type="text/javascript">

class sceneIntro extends Phaser.Scene{
    constructor(){
        super('sceneIntro');
    }

        preload(){
            this.load.image('boutonStart', 'assets/boutonStart.png')
            this.load.image('fondIntro', 'assets/ecran titre.png')
        }

        create(){
        this.SubsCount = 0;
        this.PointCoeur = 3;

        const self = this;

        this.startButton = this.add.image(480, 270, 'boutonStart').setInteractive();

        this.startButton.on('pointerdown', function (pointer) {
        self.scene.start('scene1', {coeur : this.PointCoeur, x : 0, y : 0, subs : this.SubsCount})
        });
            

        this.add.image(480, 270, 'fondIntro');
        };

        update(){
            //this.scene.start('scene1', {coeur : this.PointCoeur, x : 0, y : 0, subs : this.SubsCount})
        };
}

class scene1 extends Phaser.Scene{
    constructor(){
        super("scene1");
    }

    init(data)
    {
        console.log('init', data);

        this.PointCoeur = data.coeur;

        this.spawnX = data.x;
        this.spawnY = data.y;
    }

    preload(){
        //this.load.image("Phaser_tuilesdejeu", "assets/tuilesJeu.png");

        //this.load.image('hero', 'assets/test_png.png');
        this.load.spritesheet('heroWalk', 'assets/sprite sheets fusette.png',
        { frameWidth: 32, frameHeight: 32 });
        this.load.image('map', 'assets/map_test.jpg');
        this.load.image('spritePV', 'assets/point de vie.png');
        this.load.image('spritePVvide', 'assets/point de vie vide.png');

        //ennemis
        this.load.image('lul', 'assets/emoteLuL.png');
        this.load.image('kappa', 'assets/emoteKappa.png');
        this.load.image('pogg', 'assets/emotePogg.png');

        //raids
        this.load.image('bullet_left', 'assets/raidtest.png');
        this.load.image('bullet_right', 'assets/raidright.png');
        this.load.image('bullet_up', 'assets/raidup.png');
        this.load.image('bullet_down', 'assets/raiddown.png');

        //decors
        this.load.image('tag', 'assets/tag.png')
        this.load.image('messageChat_right', 'assets/bloc texte 1.png')
        this.load.image('messageChat_left', 'assets/bloc texte 2.png')
        this.load.image('messageChat_middle', 'assets/bloc texte 3.png')

        //Subs
        this.load.spritesheet('subs', 'assets/subs et emote.png', 
        {frameWidth: 32, frameHeight: 32})
        
        //Tiled
        this.load.tilemapTiledJSON("Background", 'assets/tiled level/background_test..json');
        this.load.image("Phaser_tuilesdejeu", 'assets/tiled level/background tiles.png');
        this.load.image("ongletsTiled", 'assets/onglets.png');
    }

    create(){  

        //CARTE DU NIVEAU
        const carteDuNiveau = this.add.tilemap("Background");

            // importer TileSet 
            const tileset = carteDuNiveau.addTilesetImage(
                    "background",
                    "Phaser_tuilesdejeu"
                    );
            const tileset2 = carteDuNiveau.addTilesetImage(
                    "onglets",
                    "ongletsTiled"
                    );                  

            // importer les calques 
            const fond = carteDuNiveau.createStaticLayer(
                    "fond",
                    tileset
                    );
            const deco = carteDuNiveau.createStaticLayer(
                    "deco",
                    tileset2
                    );
            const blocs = carteDuNiveau.createStaticLayer(
                    "blocs",
                    tileset
                    );
            const emoteblocs = carteDuNiveau.createStaticLayer(
                    "emote_wall",
                    tileset
                    );
            emoteblocs.visible = false;
            const TPblocs = carteDuNiveau.createStaticLayer(
                    "linkTP",
                    tileset
                    );
            TPblocs.visible = false;
            const TPtweet = carteDuNiveau.createStaticLayer(
                    "linkTP_twitter",
                    tileset
                    );
            TPtweet.visible = false;

            //bloc Ã  pousser
            this.tags = this.physics.add.group()

            this.physics.add.collider(this.tags, blocs, function TagWall(tag, blocs){tag.setPushable(false);});
        
            this.tag1 = this.tags.create(30 * 32 + 16, 8 * 32 + 16, 'tag');
            this.tag1.setPushable(false);
            this.tag2 = this.tags.create(23 * 32 + 16, 11 * 32 + 16, 'tag');
            this.tag2.setPushable(false);

            this.tag3 = this.tags.create(8 * 32 + 16, 13 * 32 + 16, 'tag');
            this.tag3.setPushable(false);

            //bloc qui bougent
            this.chats = this.physics.add.staticGroup();

            this.chat1 = this.chats.create(1 * 32 + 80, 16 * 32, 'messageChat_right');
            this.chat1.setSize(96, 32);
            this.chat1.setOffset(8, 8);

            this.chat2 = this.chats.create(1 * 32 + 80, 14 * 32, 'messageChat_left');
            this.chat2.setSize(96, 32);
            this.chat2.setOffset(8 + 48, 8);

            this.chat3 = this.chats.create(1 * 32 + 80, 12 * 32, 'messageChat_right');
            this.chat3.setSize(96, 32);
            this.chat3.setOffset(8, 8);

            this.chat4 = this.chats.create(1 * 32 + 80, 10 * 32, 'messageChat_middle');
            this.chat4.setSize(56, 32);
            this.chat4.setOffset(8, 8);
            this.chat4bis = this.chats.create(1 * 32 + 80, 10 * 32, 'messageChat_middle');
            this.chat4bis.setSize(56, 32);
            this.chat4bis.setOffset(8 + 96, 8);

            this.chat5 = this.chats.create(1 * 32 + 80, 8 * 32, 'messageChat_left');
            this.chat5.setSize(96, 32);
            this.chat5.setOffset(8 + 48, 8);

            this.chat6 = this.chats.create(1 * 32 + 80, 6 * 32, 'messageChat_middle');
            this.chat6.setSize(56, 32);
            this.chat6.setOffset(8, 8);
            this.chat6bis = this.chats.create(1 * 32 + 80, 6 * 32, 'messageChat_middle');
            this.chat6bis.setSize(56, 32);
            this.chat6bis.setOffset(8 + 96, 8);

            this.chatTimer = 0;
            this.chatTop = 6;

            this.physics.add.collider(this.chats, this.chats);
            this.physics.add.collider(blocs, this.chats);

        //PERSONNAGE
        //this.player = this.physics.add.sprite(29 * 32 + 16, 2 * 32 + 16, 'heroWalk');
        if (typeof this.spawnY == 'undefined') {
            this.spawnY = 0;
        }

        if (this.spawnY < 100) {this.player = this.physics.add.sprite(3 * 32 + 16, 2 * 32 + 16, 'heroWalk');}
        else {this.player = this.physics.add.sprite(this.spawnX, this.spawnY, 'heroWalk');}

        this.player.setSize(24, 20)
        this.player.setOffset(4, 12)  
        
        this.direction = 0;
        this.attaque = false;

        blocs.setCollisionByProperty({ estSolide: true });       
        this.physics.add.collider(this.player, blocs);
        this.physics.add.collider(this.player, this.chats);


        this.physics.add.collider(this.tags, this.player);

        function leTP() {
            this.scene.start('scene2', {coeur : this.PointCoeur, x : this.player.x, y : this.player.y, subs : this.SubsCount});
        }
        function leTP2() {
            this.scene.start('scene3', {coeur : this.PointCoeur, x : this.player.x, y : this.player.y, subs : this.SubsCount});
        }

        //TP entre les pages
        TPtweet.setCollisionByProperty({ linkTP: true });
        this.physics.add.collider(this.player, TPtweet, leTP2, null, this);

        TPblocs.setCollisionByProperty({ linkTP: true });
        this.physics.add.collider(this.player, TPblocs, leTP, null, this);

        //animation
        this.anims.create({
                key: 'FusetteWalkDown',
                frames: this.anims.generateFrameNumbers('heroWalk', {start:0,end:3}),
                frameRate: 10,
                repeat: -1
            });
        this.anims.create({
                key: 'FusetteWalkUp',
                frames: this.anims.generateFrameNumbers('heroWalk', {start:4,end:7}),
                frameRate: 10,
                repeat: -1
            });
        this.anims.create({
                key: 'FusetteWalkLeft',
                frames: this.anims.generateFrameNumbers('heroWalk', {start:8,end:11}),
                frameRate: 10,
                repeat: -1
            });
        this.anims.create({
                key: 'FusetteWalkRight',
                frames: this.anims.generateFrameNumbers('heroWalk', {start:12,end:15}),
                frameRate: 10,
                repeat: -1
            });
        //static frame
        this.anims.create({
                key: 'idleDown',
                frames: [ { key: 'heroWalk', frame: 0 } ],
                frameRate: 20
            });
        this.anims.create({
                key: 'idleUp',
                frames: [ { key: 'heroWalk', frame: 4 } ],
                frameRate: 20
            });
        this.anims.create({
                key: 'idleLeft',
                frames: [ { key: 'heroWalk', frame: 8 } ],
                frameRate: 20
            });
        this.anims.create({
                key: 'idleRight',
                frames: [ { key: 'heroWalk', frame: 12 } ],
                frameRate: 20
            });
        //Attack
        this.anims.create({
                key: 'FusetteShootLeft',
                frames: this.anims.generateFrameNumbers('heroWalk', {start:16,end:19}),
                frameRate: 10,
                repeat: -1
            });
        this.anims.create({
                key: 'FusetteShootRight',
                frames: this.anims.generateFrameNumbers('heroWalk', {start:20,end:23}),
                frameRate: 10,
                repeat: -1
            });
        this.anims.create({
                key: 'FusetteShootUp',
                frames: this.anims.generateFrameNumbers('heroWalk', {start:28,end:31}),
                frameRate: 10,
                repeat: -1
            });
        this.anims.create({
                key: 'FusetteShootDown',
                frames: this.anims.generateFrameNumbers('heroWalk', {start:24,end:27}),
                frameRate: 10,
                repeat: -1
            });
            

        function hitraids(raid){
            raid.destroy();
        }

        function destroytag(raid, tag) {
            raid.setPushable(true);

            if (raid.body.velocity.x > 0) {tag.setVelocityX(200)}
            else if (raid.body.velocity.x < 0) {tag.setVelocityX(-200)}
            else if (raid.body.velocity.y > 0) {tag.setVelocityY(200)}
            else if (raid.body.velocity.y < 0) {tag.setVelocityY(-200)}
            else {tag.setVelocityY(30);}

            raid.destroy();
        }

        this.raids = this.physics.add.group();
    
        this.cursors = this.input.keyboard.createCursorKeys();
        this.keys = this.input.keyboard.addKeys({
            z:  Phaser.Input.Keyboard.KeyCodes.Z,
        });

        this.physics.add.overlap(this.raids, this.tags, destroytag, null, this);
        this.physics.add.collider(this.raids, blocs, hitraids, null, this);


        //EMOTE

        this.emotes = this.physics.add.group();
        this.emote = this.emotes.create(9*32 + 16, 8*32 + 16, 'pogg');
        this.emote.setVelocityX(75);
        this.emote.setVelocityY(75);
        this.emote.setBounce(1);
        this.emote = this.emotes.create(11*32 + 16, 8*32 + 16, 'kappa');
        this.emote.setVelocityX(-100);
        this.emote.setVelocityY(50);
        this.emote.setBounce(1);
        this.emote = this.emotes.create(13*32 + 16, 8*32 + 16, 'lul');
        this.emote.setVelocityX(50);
        this.emote.setVelocityY(-100);
        this.emote.setBounce(1);

        emoteblocs.setCollisionByProperty({ emoteSolide: true });
        this.physics.add.collider(this.emotes, emoteblocs);
        

        //CAMERA
        this.cameras.main.zoom = 2;

        this.cameras.main.setBounds(0, 0, 32*32, 18*32);
        this.cameras.main.startFollow(this.player);


        //LIFE MANAGER
        if (typeof this.PointCoeur == 'undefined') {
            this.PointCoeur = 3;
        }
        if (typeof this.SubsCount == 'undefined') {
            this.SubsCount = 0;
        }
        this.invincibleFrame = false;

        this.PointVie1 = this.add.image(24 + 240, 24 + 135,'spritePV');
        this.PointVie1.setScrollFactor(0);
        this.PointVie2 = this.add.image(24 + 240 + 48, 24 + 135,'spritePV');
        this.PointVie2.setScrollFactor(0);
        this.PointVie3 = this.add.image(24 + 240 + 48*2, 24 + 135,'spritePV');
        this.PointVie3.setScrollFactor(0);

        this.afficheSubs = this.add.text(this.player.x, this.player.y, this.SubsCount);
        this.afficheSubs.setScrollFactor(0);

        function playerHit(player, emote) {
            if (this.invincibleFrame == 0) {
                this.PointCoeur -= 1;
                this.invincibleFrame = 40;
            }
        }

        this.physics.add.overlap(this.player, this.emotes, playerHit, null, this);

    }
//UPDATE UPDATE UPDATE UPDATE UPDATE UPDATE UPDATE UPDATE
    update(){
        //blocs qui bougent
        this.chatTimer += 1;
        if (this.chatTimer == 300) {
            this.chatTimer = 0;

            if (this.player.x < 6*32) {
                if (this.player.y > 5*32) {
                    this.player.y -= 64;
                }
            }

            //mouvement du chat
            if (this.chatTop == 6){
                this.chat1.y = 14*32;
                this.chat2.y = 12*32;
                this.chat3.y = 10*32;
                this.chat4.y = 8*32;
                this.chat4bis.y = 8*32;
                this.chat5.y = 6*32;
                this.chat6.y = 16*32;
                this.chat6bis.y = 16*32;

                this.chat1.body.y = 13*32 + 8;
                this.chat2.body.y = 11*32 + 8;
                this.chat3.body.y = 9*32 + 8;
                this.chat4.body.y = 7*32 + 8;
                this.chat4bis.body.y = 7*32 + 8;
                this.chat5.body.y = 5*32 + 8;
                this.chat6.body.y = 15*32 + 8;
                this.chat6bis.body.y = 15*32 + 8;
            }
            else if (this.chatTop == 5){
                this.chat1.y = 12*32;
                this.chat2.y = 10*32;
                this.chat3.y = 8*32;
                this.chat4.y = 6*32;
                this.chat4bis.y = 6*32;
                this.chat5.y = 16*32;
                this.chat6.y = 14*32;
                this.chat6bis.y = 14*32;

                this.chat1.body.y = 11*32 + 8;
                this.chat2.body.y = 9*32 + 8;
                this.chat3.body.y = 7*32 + 8;
                this.chat4.body.y = 5*32 + 8;
                this.chat4bis.body.y = 5*32 + 8;
                this.chat5.body.y = 15*32 + 8;
                this.chat6.body.y = 13*32 + 8;
                this.chat6bis.body.y = 13*32 + 8;
            }
            else if (this.chatTop == 4){
                this.chat1.y = 10*32;
                this.chat2.y = 8*32;
                this.chat3.y = 6*32;
                this.chat4.y = 16*32;
                this.chat4bis.y = 16*32;
                this.chat5.y = 14*32;
                this.chat6.y = 12*32;
                this.chat6bis.y = 12*32;

                this.chat1.body.y = 9*32 + 8;
                this.chat2.body.y = 7*32 + 8;
                this.chat3.body.y = 5*32 + 8;
                this.chat4.body.y = 15*32 + 8;
                this.chat4bis.body.y = 15*32 + 8;
                this.chat5.body.y = 13*32 + 8;
                this.chat6.body.y = 11*32 + 8;
                this.chat6bis.body.y = 11*32 + 8;
            }
            else if (this.chatTop == 3){
                this.chat1.y = 8*32;
                this.chat2.y = 6*32;
                this.chat3.y = 16*32;
                this.chat4.y = 14*32;
                this.chat4bis.y = 14*32;
                this.chat5.y = 12*32;
                this.chat6.y = 10*32;
                this.chat6bis.y = 10*32;

                this.chat1.body.y = 7*32 + 8;
                this.chat2.body.y = 5*32 + 8;
                this.chat3.body.y = 15*32 + 8;
                this.chat4.body.y = 13*32 + 8;
                this.chat4bis.body.y = 13*32 + 8;
                this.chat5.body.y = 11*32 + 8;
                this.chat6.body.y = 9*32 + 8;
                this.chat6bis.body.y = 9*32 + 8;
            }
            else if (this.chatTop == 2){
                this.chat1.y = 6*32;
                this.chat2.y = 16*32;
                this.chat3.y = 14*32;
                this.chat4.y = 12*32;
                this.chat4bis.y = 12*32;
                this.chat5.y = 10*32;
                this.chat6.y = 8*32;
                this.chat6bis.y = 8*32;

                this.chat1.body.y = 5*32 + 8;
                this.chat2.body.y = 15*32 + 8;
                this.chat3.body.y = 13*32 + 8;
                this.chat4.body.y = 11*32 + 8;
                this.chat4bis.body.y = 11*32 + 8;
                this.chat5.body.y = 9*32 + 8;
                this.chat6.body.y = 7*32 + 8;
                this.chat6bis.body.y = 7*32 + 8;
            }
            else if (this.chatTop == 1){
                this.chat1.y = 16*32;
                this.chat2.y = 14*32;
                this.chat3.y = 12*32;
                this.chat4.y = 10*32;
                this.chat4bis.y = 10*32;
                this.chat5.y = 8*32;
                this.chat6.y = 6*32;
                this.chat6bis.y = 6*32;

                this.chat1.body.y = 15*32 + 8;
                this.chat2.body.y = 13*32 + 8;
                this.chat3.body.y = 11*32 + 8;
                this.chat4.body.y = 9*32 + 8;
                this.chat4bis.body.y = 9*32 + 8;
                this.chat5.body.y = 7*32 + 8;
                this.chat6.body.y = 5*32 + 8;
                this.chat6bis.body.y = 5*32 + 8;
            }


            this.chatTop -= 1;
            if (this.chatTop == 0) {
                this.chatTop = 6;
            }
        }

        //Point de vies

        if (this.PointCoeur < 3) {this.PointVie3.setTexture('spritePVvide');}
        if (this.PointCoeur < 2) {this.PointVie2.setTexture('spritePVvide');}
        if (this.PointCoeur < 1) {this.PointVie1.setTexture('spritePVvide');}

        if (this.invincibleFrame != 0) {
            this.player.setTint(0xff8888);
            this.invincibleFrame -= 1;
        }
        else {
            this.player.setTint(0xffffff);
        }

        //attaque

        if (this.keys.z.isDown) {if (this.attaque == false) {
            this.attaque = true;
            if (this.direction == 0) {
                this.raid = this.raids.create(this.player.x, this.player.y, 'bullet_down');
                this.raid.setVelocityY(200);
            }
            else if (this.direction == 1) {
                this.raid = this.raids.create(this.player.x, this.player.y, 'bullet_up');
                this.raid.setVelocityY(-200);
            }
            else if (this.direction == 2) {
                this.raid = this.raids.create(this.player.x, this.player.y, 'bullet_left');
                this.raid.setVelocityX(-200);
            }
            else if (this.direction == 3) {
                this.raid = this.raids.create(this.player.x, this.player.y, 'bullet_right');
                this.raid.setVelocityX(200);
            }
            this.raid.setSize(20, 20);
            this.raid.setOffset(8, 8);
        }}

        //DÃ©placement vertical
        if (this.cursors.up.isDown){
            if (this.cursors.down.isDown) {
                this.player.setVelocityY(0);
            }
            else {
                if (this.player.body.velocity.x != 0) {
                    this.player.setVelocityY(-80);
                } else {
                    this.player.setVelocityY(-100);
                }
            }
        }
        else if (this.cursors.down.isDown){
            if (this.player.body.velocity.x != 0) {
                    this.player.setVelocityY(80);
                } else {
                    this.player.setVelocityY(100);
                }
        }
        else {this.player.setVelocityY(0);}
        //DÃ©placement horizontal
        if (this.cursors.left.isDown){
            if (this.cursors.right.isDown) {
                this.player.setVelocityX(0);
            }
            else {
                if (this.player.body.velocity.y != 0) {
                    this.player.setVelocityX(-80);
                } else {
                    this.player.setVelocityX(-100);
                }
            }
        }
        else if (this.cursors.right.isDown){
            if (this.player.body.velocity.y != 0) {
                    this.player.setVelocityX(80);
                } else {
                    this.player.setVelocityX(100);
                }
        }
        else {this.player.setVelocityX(0);}

        //animations

        if (this.attaque == true) {
            if (this.direction == 0) {
                this.player.anims.play('FusetteShootDown', true);
                this.player.setVelocityY(-50);
            }
            else if (this.direction == 1) {
                this.player.anims.play('FusetteShootUp', true);
                this.player.setVelocityY(50);
            }
            else if (this.direction == 2) {
                this.player.anims.play('FusetteShootLeft', true);
                this.player.setVelocityX(50);
            }
            else if (this.direction == 3) {
                this.player.anims.play('FusetteShootRight', true);
                this.player.setVelocityX(-50);
            }
            if (this.player.anims.currentFrame.index == 3) {this.attaque = false;}

        }
        else {
        if (this.player.body.velocity.y > 0) {
            this.player.anims.play('FusetteWalkDown', true);
                this.direction = 0;
        }
        else if (this.player.body.velocity.y < 0) {
                this.player.anims.play('FusetteWalkUp', true);
                this.direction = 1;
        }
        else {
            if (this.player.body.velocity.x > 0){
                this.player.anims.play('FusetteWalkRight', true);
                this.direction = 3;
            }
            else if (this.player.body.velocity.x < 0){
                this.player.anims.play('FusetteWalkLeft', true);
                this.direction = 2;
            }
        }

        if (this.player.body.velocity.y == 0) {if (this.player.body.velocity.x == 0) {
            {
                if (this.direction == 0) {this.player.anims.play('idleDown');}
                else if (this.direction == 1) {this.player.anims.play('idleUp');}
                else if (this.direction == 2) {this.player.anims.play('idleLeft');}
                else if (this.direction == 3) {this.player.anims.play('idleRight');}
            }
        }}}


    }
};
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
////////////////////////////////SCENE 2///////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////

class scene2 extends Phaser.Scene{
    constructor(){
        super("scene2");
    }

    init(data)
    {
        console.log('init', data);

        this.PointCoeur = data.coeur;

        this.spawnX = data.x;
        this.spawnY = data.y;
    }


    preload() {

        this.load.spritesheet('heroWalk', 'assets/sprite sheets fusette.png',
        { frameWidth: 32, frameHeight: 32 });
        this.load.image('map', 'assets/map_test.jpg');
        this.load.image('spritePV', 'assets/point de vie.png');
        this.load.image('spritePVvide', 'assets/point de vie vide.png');

        //raids
        this.load.image('bullet_left', 'assets/raidtest.png');
        this.load.image('bullet_right', 'assets/raidright.png');
        this.load.image('bullet_up', 'assets/raidup.png');
        this.load.image('bullet_down', 'assets/raiddown.png');

        this.load.tilemapTiledJSON("Background_discord", 'assets/tiled level/background discord.json');
        this.load.image("Phaser_tuilesdejeu_discord", 'assets/tiled level/background discord.png');
    }

    create(){  

//CARTE DU NIVEAU
const carteDuNiveau = this.add.tilemap("Background_discord");

    // importer TileSet 
    const tileset = carteDuNiveau.addTilesetImage(
            "background discord tiles",
            "Phaser_tuilesdejeu_discord"
            );                    
    const tileset2 = carteDuNiveau.addTilesetImage(
             "onglets",
             "ongletsTiled"
              );      

    // importer les calques 
    const fond = carteDuNiveau.createStaticLayer(
            "fond",
            tileset
            );
    const deco = carteDuNiveau.createStaticLayer(
            "deco",
            tileset2
            );
    const blocs = carteDuNiveau.createStaticLayer(
            "blocs",
            tileset
            );
    const linkTPs = carteDuNiveau.createStaticLayer(
            "linkTP_twitch",
            tileset
            );
    const linkTPtwitter = carteDuNiveau.createStaticLayer(
            "linkTP_twitter",
            tileset
            );

linkTPs.visible = false;
linkTPtwitter.visible = false;

//PERSONNAGE
//this.player = this.physics.add.sprite(29 * 32 + 16, 2 * 32 + 16, 'heroWalk');

if (this.spawnY < 100) {this.player = this.physics.add.sprite(3 * 32 + 16, 2 * 32 + 16, 'heroWalk');}
else {this.player = this.physics.add.sprite(this.spawnX, this.spawnY, 'heroWalk');}
this.player.setSize(24, 20)
this.player.setOffset(4, 12)  

this.direction = 0;
this.attaque = false;

blocs.setCollisionByProperty({ estSolide: true });       
this.physics.add.collider(this.player, blocs);

function leTP() {
            this.scene.start('scene1', {coeur : this.PointCoeur, x : this.player.x, y : this.player.y, subs : this.SubsCount});
        }

linkTPs.setCollisionByProperty({ linkTP: true });
this.physics.add.collider(this.player, linkTPs, leTP, null, this);

function leTP2() {
            this.scene.start('scene3', {coeur : this.PointCoeur, x : this.player.x, y : this.player.y, subs : this.SubsCount});
        }

linkTPtwitter.setCollisionByProperty({ linkTP: true });
this.physics.add.collider(this.player, linkTPtwitter, leTP2, null, this);

//animation
this.anims.create({
        key: 'FusetteWalkDown',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:0,end:3}),
        frameRate: 10,
        repeat: -1
    });
this.anims.create({
        key: 'FusetteWalkUp',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:4,end:7}),
        frameRate: 10,
        repeat: -1
    });
this.anims.create({
        key: 'FusetteWalkLeft',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:8,end:11}),
        frameRate: 10,
        repeat: -1
    });
this.anims.create({
        key: 'FusetteWalkRight',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:12,end:15}),
        frameRate: 10,
        repeat: -1
    });
//static frame
this.anims.create({
        key: 'idleDown',
        frames: [ { key: 'heroWalk', frame: 0 } ],
        frameRate: 20
    });
this.anims.create({
        key: 'idleUp',
        frames: [ { key: 'heroWalk', frame: 4 } ],
        frameRate: 20
    });
this.anims.create({
        key: 'idleLeft',
        frames: [ { key: 'heroWalk', frame: 8 } ],
        frameRate: 20
    });
this.anims.create({
        key: 'idleRight',
        frames: [ { key: 'heroWalk', frame: 12 } ],
        frameRate: 20
    });
//Attack
this.anims.create({
        key: 'FusetteShootLeft',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:16,end:19}),
        frameRate: 10,
        repeat: -1
    });
this.anims.create({
        key: 'FusetteShootRight',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:20,end:23}),
        frameRate: 10,
        repeat: -1
    });
this.anims.create({
        key: 'FusetteShootUp',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:28,end:31}),
        frameRate: 10,
        repeat: -1
    });
this.anims.create({
        key: 'FusetteShootDown',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:24,end:27}),
        frameRate: 10,
        repeat: -1
    });
    

function hitraids(raid){
    raid.destroy();
}

this.raids = this.physics.add.group();

this.cursors = this.input.keyboard.createCursorKeys();
this.keys = this.input.keyboard.addKeys({
    z:  Phaser.Input.Keyboard.KeyCodes.Z,
});

this.physics.add.collider(this.raids, blocs, hitraids, null, this);


//CAMERA
this.cameras.main.zoom = 2;

this.cameras.main.setBounds(0, 0, 32*32, 18*32);
this.cameras.main.startFollow(this.player);


//LIFE MANAGER
this.invincibleFrame = false;

this.PointVie1 = this.add.image(24 + 240, 24 + 135,'spritePV');
this.PointVie1.setScrollFactor(0);
this.PointVie2 = this.add.image(24 + 240 + 48, 24 + 135,'spritePV');
this.PointVie2.setScrollFactor(0);
this.PointVie3 = this.add.image(24 + 240 + 48*2, 24 + 135,'spritePV');
this.PointVie3.setScrollFactor(0);
}

update(){
        //Point de vies

        if (this.PointCoeur < 3) {this.PointVie3.setTexture('spritePVvide');}
        if (this.PointCoeur < 2) {this.PointVie2.setTexture('spritePVvide');}
        if (this.PointCoeur < 1) {this.PointVie1.setTexture('spritePVvide');}

        if (this.invincibleFrame != 0) {
            this.player.setTint(0xff8888);
            this.invincibleFrame -= 1;
        }
        else {
            this.player.setTint(0xffffff);
        }

        //attaque

        if (this.keys.z.isDown) {if (this.attaque == false) {
            this.attaque = true;
            if (this.direction == 0) {
                this.raid = this.raids.create(this.player.x, this.player.y, 'bullet_down');
                this.raid.setVelocityY(200);
            }
            else if (this.direction == 1) {
                this.raid = this.raids.create(this.player.x, this.player.y, 'bullet_up');
                this.raid.setVelocityY(-200);
            }
            else if (this.direction == 2) {
                this.raid = this.raids.create(this.player.x, this.player.y, 'bullet_left');
                this.raid.setVelocityX(-200);
            }
            else if (this.direction == 3) {
                this.raid = this.raids.create(this.player.x, this.player.y, 'bullet_right');
                this.raid.setVelocityX(200);
            }
            this.raid.setSize(20, 20);
            this.raid.setOffset(8, 8);
        }}

        //DÃ©placement vertical
        if (this.cursors.up.isDown){
            if (this.cursors.down.isDown) {
                this.player.setVelocityY(0);
            }
            else {
                if (this.player.body.velocity.x != 0) {
                    this.player.setVelocityY(-80);
                } else {
                    this.player.setVelocityY(-100);
                }
            }
        }
        else if (this.cursors.down.isDown){
            if (this.player.body.velocity.x != 0) {
                    this.player.setVelocityY(80);
                } else {
                    this.player.setVelocityY(100);
                }
        }
        else {this.player.setVelocityY(0);}
        //DÃ©placement horizontal
        if (this.cursors.left.isDown){
            if (this.cursors.right.isDown) {
                this.player.setVelocityX(0);
            }
            else {
                if (this.player.body.velocity.y != 0) {
                    this.player.setVelocityX(-80);
                } else {
                    this.player.setVelocityX(-100);
                }
            }
        }
        else if (this.cursors.right.isDown){
            if (this.player.body.velocity.y != 0) {
                    this.player.setVelocityX(80);
                } else {
                    this.player.setVelocityX(100);
                }
        }
        else {this.player.setVelocityX(0);}

        //animations

        if (this.attaque == true) {
            if (this.direction == 0) {
                this.player.anims.play('FusetteShootDown', true);
                this.player.setVelocityY(-50);
            }
            else if (this.direction == 1) {
                this.player.anims.play('FusetteShootUp', true);
                this.player.setVelocityY(50);
            }
            else if (this.direction == 2) {
                this.player.anims.play('FusetteShootLeft', true);
                this.player.setVelocityX(50);
            }
            else if (this.direction == 3) {
                this.player.anims.play('FusetteShootRight', true);
                this.player.setVelocityX(-50);
            }
            if (this.player.anims.currentFrame.index == 3) {this.attaque = false;}

        }
        else {
        if (this.player.body.velocity.y > 0) {
            this.player.anims.play('FusetteWalkDown', true);
                this.direction = 0;
        }
        else if (this.player.body.velocity.y < 0) {
                this.player.anims.play('FusetteWalkUp', true);
                this.direction = 1;
        }
        else {
            if (this.player.body.velocity.x > 0){
                this.player.anims.play('FusetteWalkRight', true);
                this.direction = 3;
            }
            else if (this.player.body.velocity.x < 0){
                this.player.anims.play('FusetteWalkLeft', true);
                this.direction = 2;
            }
        }

        if (this.player.body.velocity.y == 0) {if (this.player.body.velocity.x == 0) {
            {
                if (this.direction == 0) {this.player.anims.play('idleDown');}
                else if (this.direction == 1) {this.player.anims.play('idleUp');}
                else if (this.direction == 2) {this.player.anims.play('idleLeft');}
                else if (this.direction == 3) {this.player.anims.play('idleRight');}
            }
        }}}


    }

}

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
////////////////////////////////SCENE 3///////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////

class scene3 extends Phaser.Scene{
    constructor(){
        super("scene3");
    }

    init(data)
    {
        console.log('init', data);

        this.PointCoeur = data.coeur;

        this.spawnX = data.x;
        this.spawnY = data.y;
    }

    preload() {

        this.load.spritesheet('heroWalk', 'assets/sprite sheets fusette.png',
        { frameWidth: 32, frameHeight: 32 });
        this.load.image('map', 'assets/map_test.jpg');
        this.load.image('spritePV', 'assets/point de vie.png');
        this.load.image('spritePVvide', 'assets/point de vie vide.png');

        //raids
        this.load.image('bullet_left', 'assets/raidtest.png');
        this.load.image('bullet_right', 'assets/raidright.png');
        this.load.image('bullet_up', 'assets/raidup.png');
        this.load.image('bullet_down', 'assets/raiddown.png');

        //Ennemis wojak
        this.load.spritesheet('wojak', 'assets/wojaks.png',
        {frameWidth: 32, frameHeight: 32});

        this.load.tilemapTiledJSON("Background_twitter", 'assets/tiled level/background twitter tiled.json');
        this.load.image("Phaser_tuilesdejeu_twitter", 'assets/tiled level/background twitter.png');
    }

    create(){  

//CARTE DU NIVEAU
const carteDuNiveau = this.add.tilemap("Background_twitter");

    // importer TileSet 
    const tileset = carteDuNiveau.addTilesetImage(
            "background twitter",
            "Phaser_tuilesdejeu_twitter"
            );
    const tileset2 = carteDuNiveau.addTilesetImage(
             "onglets",
             "ongletsTiled"
              );   

    // importer les calques 
    const fond = carteDuNiveau.createStaticLayer(
            "fond",
            tileset
            );
    const deco = carteDuNiveau.createStaticLayer(
            "deco",
            tileset2
            );
    const blocs = carteDuNiveau.createStaticLayer(
            "blocs",
            tileset
            );
    const linkTPs = carteDuNiveau.createStaticLayer(
            "linkTP_twitch",
            tileset
            );
    const linkTPdiscord = carteDuNiveau.createStaticLayer(
            "linkTP_discord",
            tileset
            );

linkTPs.visible = false;
linkTPdiscord.visible = false;

//PERSONNAGE
//this.player = this.physics.add.sprite(29 * 32 + 16, 2 * 32 + 16, 'heroWalk');
if (this.spawnY < 100) {this.player = this.physics.add.sprite(3 * 32 + 16, 2 * 32 + 16, 'heroWalk');}
else {this.player = this.physics.add.sprite(this.spawnX, this.spawnY, 'heroWalk');}

this.player.setSize(24, 20)
this.player.setOffset(4, 12)  

this.direction = 0;
this.attaque = false;

blocs.setCollisionByProperty({ estSolide: true });       
this.physics.add.collider(this.player, blocs);

function leTP() {
            this.scene.start('scene1', {coeur : this.PointCoeur, x : this.player.x, y : this.player.y, subs : this.SubsCount});
        }
function leTP2() {
            this.scene.start('scene2', {coeur : this.PointCoeur, x : this.player.x, y : this.player.y, subs : this.SubsCount});
        }

linkTPs.setCollisionByProperty({ linkTP: true });
this.physics.add.collider(this.player, linkTPs, leTP, null, this);

linkTPdiscord.setCollisionByProperty({ linkTP: true });
this.physics.add.collider(this.player, linkTPdiscord, leTP2, null, this);

//animation
this.anims.create({
        key: 'FusetteWalkDown',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:0,end:3}),
        frameRate: 10,
        repeat: -1
    });
this.anims.create({
        key: 'FusetteWalkUp',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:4,end:7}),
        frameRate: 10,
        repeat: -1
    });
this.anims.create({
        key: 'FusetteWalkLeft',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:8,end:11}),
        frameRate: 10,
        repeat: -1
    });
this.anims.create({
        key: 'FusetteWalkRight',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:12,end:15}),
        frameRate: 10,
        repeat: -1
    });
//static frame
this.anims.create({
        key: 'idleDown',
        frames: [ { key: 'heroWalk', frame: 0 } ],
        frameRate: 20
    });
this.anims.create({
        key: 'idleUp',
        frames: [ { key: 'heroWalk', frame: 4 } ],
        frameRate: 20
    });
this.anims.create({
        key: 'idleLeft',
        frames: [ { key: 'heroWalk', frame: 8 } ],
        frameRate: 20
    });
this.anims.create({
        key: 'idleRight',
        frames: [ { key: 'heroWalk', frame: 12 } ],
        frameRate: 20
    });
//Attack
this.anims.create({
        key: 'FusetteShootLeft',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:16,end:19}),
        frameRate: 10,
        repeat: -1
    });
this.anims.create({
        key: 'FusetteShootRight',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:20,end:23}),
        frameRate: 10,
        repeat: -1
    });
this.anims.create({
        key: 'FusetteShootUp',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:28,end:31}),
        frameRate: 10,
        repeat: -1
    });
this.anims.create({
        key: 'FusetteShootDown',
        frames: this.anims.generateFrameNumbers('heroWalk', {start:24,end:27}),
        frameRate: 10,
        repeat: -1
    });
    

function hitraids(raid){
    raid.destroy();
}

this.raids = this.physics.add.group();

this.cursors = this.input.keyboard.createCursorKeys();
this.keys = this.input.keyboard.addKeys({
    z:  Phaser.Input.Keyboard.KeyCodes.Z,
});

this.physics.add.collider(this.raids, blocs, hitraids, null, this);

//ENNEMIS
this.anims.create({
        key: 'wojak_pointing',
        frames: this.anims.generateFrameNumbers('wojak', {start:4,end:7}),
        frameRate: 10,
        repeat: -1
    });
this.anims.create({
        key: 'wojak_nerd',
        frames: this.anims.generateFrameNumbers('wojak', {start:0,end:3}),
        frameRate: 10,
        repeat: -1
    });


this.wojakEnnemis = this.physics.add.group()


    carteDuNiveau.getObjectLayer('wojakEnnemis').objects.forEach((wojakEnnemis) => {
    this.wojak = this.wojakEnnemis.create(wojakEnnemis.x, wojakEnnemis.y, 'wojak');
    this.wojak.anims.play('wojak_pointing', true);
    this.wojak.setSize(32, 16);
    this.wojak.setOffset(0, 16);
    });

    carteDuNiveau.getObjectLayer('wojakNerd').objects.forEach((wojakEnnemis) => {
    this.wojak = this.wojakEnnemis.create(wojakEnnemis.x, wojakEnnemis.y, 'wojak');
    this.wojak.anims.play('wojak_nerd', true);
    this.wojak.setSize(32, 16);
    this.wojak.setOffset(0, 16);
    });


function destroyBoth(raid, wojaksss) {
    raid.destroy();
    wojaksss.destroy();
}

this.physics.add.collider(this.raids, this.wojakEnnemis, destroyBoth, null, this);
this.physics.add.collider(blocs, this.wojakEnnemis)


//CAMERA
this.cameras.main.zoom = 2;

this.cameras.main.setBounds(0, 0, 32*32, 18*32);
this.cameras.main.startFollow(this.player);


//LIFE MANAGER
this.invincibleFrame = false;

this.PointVie1 = this.add.image(24 + 240, 24 + 135,'spritePV');
this.PointVie1.setScrollFactor(0);
this.PointVie2 = this.add.image(24 + 240 + 48, 24 + 135,'spritePV');
this.PointVie2.setScrollFactor(0);
this.PointVie3 = this.add.image(24 + 240 + 48*2, 24 + 135,'spritePV');
this.PointVie3.setScrollFactor(0);

function playerHit(player, emote) {
            if (this.invincibleFrame == 0) {
                this.PointCoeur -= 1;
                this.invincibleFrame = 40;
            }
        }

        this.physics.add.overlap(this.player, this.wojakEnnemis, playerHit, null, this);

}

update(){
        //Point de vies

        if (this.PointCoeur < 3) {this.PointVie3.setTexture('spritePVvide');}
        if (this.PointCoeur < 2) {this.PointVie2.setTexture('spritePVvide');}
        if (this.PointCoeur < 1) {this.PointVie1.setTexture('spritePVvide');}

        if (this.invincibleFrame != 0) {
            this.player.setTint(0xff8888);
            this.invincibleFrame -= 1;
        }
        else {
            this.player.setTint(0xffffff);
        }

        //Ennemis
        this.wojakEnnemis.children.each(function(enemy) {
            if (Phaser.Math.Distance.BetweenPoints(this.player, enemy) < 200) {
            if (this.player.x < enemy.x) {
            enemy.setVelocityX(-30);
            }
            else {
                enemy.setVelocityX(30);
            }
            if (this.player.y < enemy.y) {
            enemy.setVelocityY(-30);
            }
            else {
                enemy.setVelocityY(30);
            }
        } else {enemy.setVelocityY(0); enemy.setVelocityX(0);}
        }, this);


        //Attaque

        if (this.keys.z.isDown) {if (this.attaque == false) {
            this.attaque = true;
            if (this.direction == 0) {
                this.raid = this.raids.create(this.player.x, this.player.y, 'bullet_down');
                this.raid.setVelocityY(200);
            }
            else if (this.direction == 1) {
                this.raid = this.raids.create(this.player.x, this.player.y, 'bullet_up');
                this.raid.setVelocityY(-200);
            }
            else if (this.direction == 2) {
                this.raid = this.raids.create(this.player.x, this.player.y, 'bullet_left');
                this.raid.setVelocityX(-200);
            }
            else if (this.direction == 3) {
                this.raid = this.raids.create(this.player.x, this.player.y, 'bullet_right');
                this.raid.setVelocityX(200);
            }
            this.raid.setSize(20, 20);
            this.raid.setOffset(8, 8);
        }}

        //DÃ©placement vertical
        if (this.cursors.up.isDown){
            if (this.cursors.down.isDown) {
                this.player.setVelocityY(0);
            }
            else {
                if (this.player.body.velocity.x != 0) {
                    this.player.setVelocityY(-80);
                } else {
                    this.player.setVelocityY(-100);
                }
            }
        }
        else if (this.cursors.down.isDown){
            if (this.player.body.velocity.x != 0) {
                    this.player.setVelocityY(80);
                } else {
                    this.player.setVelocityY(100);
                }
        }
        else {this.player.setVelocityY(0);}
        //DÃ©placement horizontal
        if (this.cursors.left.isDown){
            if (this.cursors.right.isDown) {
                this.player.setVelocityX(0);
            }
            else {
                if (this.player.body.velocity.y != 0) {
                    this.player.setVelocityX(-80);
                } else {
                    this.player.setVelocityX(-100);
                }
            }
        }
        else if (this.cursors.right.isDown){
            if (this.player.body.velocity.y != 0) {
                    this.player.setVelocityX(80);
                } else {
                    this.player.setVelocityX(100);
                }
        }
        else {this.player.setVelocityX(0);}

        //animations

        if (this.attaque == true) {
            if (this.direction == 0) {
                this.player.anims.play('FusetteShootDown', true);
                this.player.setVelocityY(-50);
            }
            else if (this.direction == 1) {
                this.player.anims.play('FusetteShootUp', true);
                this.player.setVelocityY(50);
            }
            else if (this.direction == 2) {
                this.player.anims.play('FusetteShootLeft', true);
                this.player.setVelocityX(50);
            }
            else if (this.direction == 3) {
                this.player.anims.play('FusetteShootRight', true);
                this.player.setVelocityX(-50);
            }
            if (this.player.anims.currentFrame.index == 3) {this.attaque = false;}

        }
        else {
        if (this.player.body.velocity.y > 0) {
            this.player.anims.play('FusetteWalkDown', true);
                this.direction = 0;
        }
        else if (this.player.body.velocity.y < 0) {
                this.player.anims.play('FusetteWalkUp', true);
                this.direction = 1;
        }
        else {
            if (this.player.body.velocity.x > 0){
                this.player.anims.play('FusetteWalkRight', true);
                this.direction = 3;
            }
            else if (this.player.body.velocity.x < 0){
                this.player.anims.play('FusetteWalkLeft', true);
                this.direction = 2;
            }
        }

        if (this.player.body.velocity.y == 0) {if (this.player.body.velocity.x == 0) {
            {
                if (this.direction == 0) {this.player.anims.play('idleDown');}
                else if (this.direction == 1) {this.player.anims.play('idleUp');}
                else if (this.direction == 2) {this.player.anims.play('idleLeft');}
                else if (this.direction == 3) {this.player.anims.play('idleRight');}
            }
        }}}


    }

}

var config = {
        type: Phaser.AUTO,
        width: 960, height: 540,
        physics: {
        default: 'arcade',
        arcade: {
        debug: false
        }},
        pixelArt: true,
        roundPixels: true,
        scene: [sceneIntro, scene1, scene2, scene3]
        };

        new Phaser.Game(config);

</script>
</body>
    
</html>